<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Telegram Admin</title>

    <style>
        body {
            margin: 0;
            font-family: monospace;
            background: #0f1115;
            color: #eaeaea;
        }

        header {
            padding: 12px 16px;
            background: #1a1d24;
            border-bottom: 1px solid #2a2f3a;
        }

        #status {
            color: #7ee787;
        }

        #messages {
            padding: 16px;
            height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .msg {
            margin-bottom: 10px;
            padding: 8px 10px;
            background: #161a22;
            border-left: 3px solid #3b82f6;
        }

        .chat {
            color: #93c5fd;
            font-size: 12px;
        }

        .user {
            color: #facc15;
            font-size: 12px;
        }

        .text {
            margin-top: 4px;
            white-space: pre-wrap;
        }
        .notify {
            display: inline-block;
            margin-left: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        .notify.ok { background: #062e1b; color: #7ee787; border: 1px solid #164b2e }
        .notify.err { background: #2b0505; color: #ffb4b4; border: 1px solid #5a1a1a }
    </style>
</head>
<body>

<header>
    <strong>Telegram Admin</strong>
    — <span id="status">connecting...</span>
    <span class="controls" style="margin-left:16px">
        Account:
        <select id="accountSelect" aria-label="Select account">
            <option value="">(none)</option>
        </select>
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <label style="margin-left:8px">filter chat id: <input id="chatFilter" placeholder="optional chat id" style="width:120px" /></label>
        <span id="notify" class="notify" style="display:none"></span>
    </span>
</header>

<div id="messages"></div>

<script>
    const statusEl = document.getElementById("status")
    const messagesEl = document.getElementById("messages")
    const accountSelect = document.getElementById("accountSelect")
    const startBtn = document.getElementById("startBtn")
    const stopBtn = document.getElementById("stopBtn")
    const chatFilterEl = document.getElementById("chatFilter")

    let selectedLogin = localStorage.getItem("selectedLogin") || ""
    let logins = {}

    const ws = new WebSocket(`ws://${location.host}/auth/ws/messages`)

    ws.onopen = () => {
        statusEl.textContent = "connected"
        statusEl.style.color = "#7ee787"
    }

    ws.onclose = () => {
        statusEl.textContent = "disconnected"
        statusEl.style.color = "#f87171"
    }

    ws.onerror = () => {
        statusEl.textContent = "error"
        statusEl.style.color = "#f87171"
    }

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data)
    // filter by selected login (if any)
    if (selectedLogin && data.login_id !== selectedLogin) return

        // filter by chat id if specified
        const chatFilter = chatFilterEl.value && chatFilterEl.value.trim()
        if (chatFilter) {
            // compare as string because chat ids may be numbers
            if (String(data.chat_id) !== String(chatFilter)) return
        }

    const div = document.createElement("div")
        div.className = "msg"

        div.innerHTML = `
            <div class="chat">
                login: ${data.login_id} — chat: ${data.chat_title || data.chat_id}
            </div>
            <div class="user">
                from: ${data.sender_username || data.sender_id}
            </div>
            <div class="text">
                ${escapeHtml(data.text || "")}
            </div>
        `

        messagesEl.appendChild(div)
        messagesEl.scrollTop = messagesEl.scrollHeight
    }

    // --- account management ---
    function setSelectedLogin(id) {
        selectedLogin = id || ""
        localStorage.setItem("selectedLogin", selectedLogin)
        // update select value
        accountSelect.value = selectedLogin
    }

    async function refreshLogins() {
        try {
            const res = await fetch('/auth/logins')
            if (!res.ok) {
                showNotification('Failed to load accounts: ' + res.status, 'err')
                return
            }
            const arr = await res.json()
            // rebuild map
            logins = {}
            // preserve previous selection if still present
            const prev = selectedLogin
            accountSelect.innerHTML = '<option value="">(none)</option>'
            arr.forEach(item => {
                logins[item.login_id] = item
                const opt = document.createElement('option')
                opt.value = item.login_id
                const friendly = item.username ? `${item.username} ` : ''
                opt.textContent = `${friendly}${item.login_id} [${item.status || 'unknown'}]${item.listener_started ? ' (listening)' : ''}`
                accountSelect.appendChild(opt)
            })
            if (prev) {
                // if previously selected login still exists, keep selection
                const found = arr.some(i => i.login_id === prev)
                if (found) setSelectedLogin(prev)
                else setSelectedLogin('')
            }
        } catch (e) {
            console.error('Failed to fetch logins', e)
            showNotification('Failed to fetch accounts: ' + e.message, 'err')
        }
    }

    accountSelect.addEventListener('change', (e) => {
        setSelectedLogin(e.target.value)
    })

    startBtn.addEventListener('click', async () => {
        if (!selectedLogin) return showNotification('Select an account first', 'err')
        try {
            const res = await fetch('/auth/listen', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({login_id: selectedLogin})})
            const j = await res.json()
            if (res.ok) {
                showNotification('Started listening', 'ok')
                await refreshLogins()
            } else {
                showNotification('Failed to start: ' + (j.detail || JSON.stringify(j)), 'err')
            }
        } catch (e) { showNotification('Start error: ' + e.message, 'err') }
    })

    stopBtn.addEventListener('click', async () => {
        if (!selectedLogin) return showNotification('Select an account first', 'err')
        try {
            const res = await fetch('/auth/unlisten', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({login_id: selectedLogin})})
            const j = await res.json()
            if (res.ok) {
                showNotification('Stopped listening', 'ok')
                await refreshLogins()
            } else {
                showNotification('Failed to stop: ' + (j.detail || JSON.stringify(j)), 'err')
            }
        } catch (e) { showNotification('Stop error: ' + e.message, 'err') }
    })

    // initial load
    setSelectedLogin(selectedLogin)
    refreshLogins()
    // refresh periodically to show status changes
    setInterval(refreshLogins, 5000)

    function showNotification(msg, type = 'ok', timeout = 4000) {
        const el = document.getElementById('notify')
        if (!el) return
        el.textContent = msg
        el.className = 'notify ' + (type === 'err' ? 'err' : 'ok')
        el.style.display = 'inline-block'
        if (timeout) setTimeout(() => { el.style.display = 'none' }, timeout)
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
    }
</script>

</body>
</html>
